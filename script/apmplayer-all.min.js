/*********************************************************************************
 *
 *   Copyright (c) 2012, American Public Media Group
 *
 *   All rights reserved.
 *
 *   Redistribution and use in source and binary forms, with or without
 *   modification, are permitted provided that the following conditions are met:
 *
 *   - Redistributions of source code must retain the above copyright notice,
 *     this list of conditions and the following disclaimer.
 *
 *   - Redistributions in binary form must reproduce the above copyright notice,
 *     this list of conditions and the following disclaimer in the documentation
 *     and/or other materials provided with the distribution.
 *
 *   - Neither the name of the American Public Media Group nor the names of
 *     its contributors may be used to endorse or promote products derived from
 *     this software without specific prior written permission.
 *
 *   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 *   AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 *   IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 *   ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 *   LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 *   OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 *   SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 *   INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 *   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 *   ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 *   POSSIBILITY OF SUCH DAMAGE.
 *
 **********************************************************************************//**
 * @name apmplayer.js
 * @fileOverview
 * @description the file contains APMPlayerFactory, APMPlayer, Playlist, Playable etc.
 * All methods are revealed via API through the use of 'revealing' or 'module' js pattern.
 */if(typeof APMPlayerFactory=="undefined")var APMPlayerFactory=function(){"use strict";var e={type:{AUDIO:"audio",LIVE_AUDIO:"live_audio"},isValid:function(t){var n;for(n in e.type)if(e.type[n]===t)return!0;return!1}},t=function(){};t.enabled=!1,t.consoleOnly=!0,t.log=function(e,n,r){if(t.enabled===!1)return;typeof soundManager!="undefined"?(typeof r=="undefined"&&(r="APMPlayer"),soundManager._writeDebug(r+"::"+e,n.id,!1)):console.log(r+"::"+e+"["+n.name+"]")},t.type={info:{id:1,name:"info"},warn:{id:2,name:"warning"},error:{id:3,name:"error"}};var n=function(){this.type={AUDIO_LIB_READY:"AUDIO_LIB_READY",MEDIA_READY:"MEDIA_READY",PLAYER_READY:"PLAYER_READY",PLAYER_FAILURE:"PLAYER_FAILURE",CONNECTION_LOST:"CONNECTION_LOST",MISSING_FILE:"MISSING_FILE",PLAYLIST_CURRENT_CHANGE:"PLAYLIST_CURRENT_CHANGE",POSITION_UPDATE:"POSITION_UPDATE",PLAYING:"PLAYING",PAUSED:"PAUSED",FINISHED:"FINISHED",UNLOADED:"UNLOADED",BUFFER_START:"BUFFER_START",BUFFER_END:"BUFFER_END",METADATA:"METADATA",VOLUME_UPDATED:"VOLUME_UPDATED"},this.handlers=[]};n.prototype={trigger:function(e,t){var n;for(n=0;n<this.handlers.length;n+=1)this.handlers[n].eventName===e&&this.handlers[n].eventHandler.call(this,t)},addListener:function(e,n){(typeof e!="string"||typeof n!="function")&&t.log("Invalid parameters when creating listener with the following arguments: 'Name': "+e+", 'Handler': "+n,t.type.error),this.handlers.push({eventName:e,eventHandler:n})},removeListeners:function(){this.handlers=[]}};var r=function(){this.type={PLAYING:"PLAYING",STOPPED:"STOPPED",PAUSED:"PAUSED"},this._current=this.type.STOPPED};r.prototype={current:function(){return this._current},set:function(e,t){this._current=e,typeof t=="object"&&t.hasOwnProperty("state")&&(t.state=this._current)}};var i=function(){this.type={FLASH:"FLASH",HTML5:"HTML5"},this.solutions=[this.type.FLASH,this.type.HTML5]};i.prototype={getCurrentSolution:function(){return this.solutions.length>0?this.solutions[0]:null},removeCurrentSolution:function(){return this.solutions.length>0?(this.solutions.shift(),!0):(t.log("PlaybackMechanism.removeCurrentSolution() no playback solutions remain to remove!",t.type.error),!1)},setSolutions:function(e){if(e instanceof Array){var n=[],r;while(e.length>0)r=e.shift(),this.isValid(r)?n.push(r):t.log("PlaybackMechanism.setSolutions() passed mechanism '"+r+"' is invalid.",t.type.error);return this.solutions=n,!0}return t.log("PlaybackMechanism.setSolutions() argument passed is not an array!",t.type.error),!1},isValid:function(e){var t;for(t in this.type)if(this.type[t]===e)return!0;return!1}};var s=function(){this.schemes=[],this.scheme_map={},this.playable_attrs=[]};s.prototype={init:function(e){this.scheme_map=e,this.initSchemeTypes(),this.initPlayableAttrs()},initSchemeTypes:function(){this.schemes=[];for(var e in this.scheme_map)this.schemes.push(e)},initPlayableAttrs:function(){this.playable_attrs=[];var e=new u({});for(var t in e)typeof e[t]!="function"&&this.playable_attrs.push(t)},hasSchemes:function(){return this.schemes.length>0?!0:!1},isValid:function(e){return this.schemes.indexOf(e)!==-1?!0:!1},isScheme:function(e,t){var n=this.parse(e);return n!==null&&n.scheme===t?!0:!1},parse:function(e){var t="^("+this.schemes.join("|")+"){1}(:/){1}([/\\w.-]+$)",n=new RegExp(t),r=e.match(n);return r!==null&&r.length===4?{scheme:r[1],path:r[3]}:null},getValues:function(e){var t={},n=this.parse(e);if(n!==null&&this.isValid(n.scheme)){var r=this.scheme_map[n.scheme];r.hasOwnProperty(n.path)&&(r=r[n.path]);for(var i in r)this.playable_attrs.indexOf(i)!==-1?t[i]=r[i]:i==="flash_file_prefix"?t.flash_file_path=r[i]+"/"+n.path:i==="http_file_prefix"&&(t.http_file_path=r[i]+"/"+n.path)}return t}};var o=new s,u=function(e){var t=this;this.identifier=null,this.type=null,this.flash_file_path="",this.flash_server_url="",this.http_file_path="",this.buffer_time=3,this.downloadable=!0,this.title="",this.description="",this.detail="",this.date="",this.program="",this.host="",this.image_sm="",this.image_lg="",this.duration=0,this.position=0,this.percent_played=0,this.percent_loaded=0,this.state="STOPPED";if(typeof e.identifier=="undefined"||e.identifier===null||e.identifier==="")return t;(function(){t.setMembers(e);if(o.hasSchemes()){var n=o.getValues(t.identifier);t.setMembers(n)}})()};u.prototype={isValid:function(){return this.identifier!==null&&this.type!==null&&e.isValid(this.type)?!0:!1},isCustomScheme:function(e){return o.isScheme(this.identifier,e)===!0?!0:!1},isEOF:function(){return this.percent_played>.99995?!0:!1},reset:function(){this.position=0,this.percent_played=0,this.percent_loaded=0},setEmptyMembers:function(e){var t;for(t in e)e.hasOwnProperty(t)&&this.hasOwnProperty(t)&&e[t]!==null&&e[t]!==""&&(this[t]===null||this[t]===""||this[t]===0)&&(this[t]=e[t])},setMembers:function(e){for(var t in e)e.hasOwnProperty(t)&&this.hasOwnProperty(t)&&(this[t]=e[t])},clearFlashProperties:function(){this.flash_server_url="",this.flash_file_path=""},isFlashStreamable:function(){return this.flash_server_url!==""&&this.flash_file_path!==""?!0:!1}};var a=function(){var s=this,o=function(){this.lib=soundManager,this.init_status=!1};return o.prototype={init:function(){s.audio.init_status===!1?(this.lib.flashVersion=9,this.lib.preferFlash=!0,this.lib.useHTML5Audio=!0,this.lib.consoleOnly=t.consoleOnly,this.lib.debugMode=t.enabled,this.lib.flashPollingInterval=150,this.lib.url=s.util.getLoadedScriptPathByFileName("soundmanager2")+"swf/",this.lib.onready(function(){s.audio.lib.html5Only===!0&&(s.mechanism.setSolutions([s.mechanism.type.HTML5]),t.log("Audio.init() -- setting to HTML5-only",t.type.info)),t.log("Audio.init() success",t.type.info),s.audio.init_status=!0,s.internal_events.trigger(s.events.type.AUDIO_LIB_READY,{})}),this.lib.ontimeout(function(e){!s.audio.lib.canPlayMIME("audio/mp3")&&!s.audio.lib.canPlayMIME("audio/mpeg")?s.mechanism.setSolutions([]):s.mechanism.setSolutions([s.mechanism.type.HTML5]),s.audio.reset()})):(s.audio.reset(),t.log("Audio.init() -- audio lib has already been initialized once, attempting reset",t.type.info))},reset:function(){s.audio.init_status=!1;var e=s.mechanism.getCurrentSolution();switch(e){case s.mechanism.type.FLASH:s.audio.lib.preferFlash=!0,s.audio.lib.html5Only=!1;break;case s.mechanism.type.HTML5:s.audio.lib.preferFlash=!1,s.audio.lib.html5Only=!0;break;default:return t.log("Audio.reset() no playback solution exists.",t.type.error),s.events.trigger(s.events.type.PLAYER_FAILURE,null),!1}s.audio.lib.reboot()},load:function(e){if(this.init_status===!0)try{var n;switch(s.mechanism.getCurrentSolution()){case s.mechanism.type.FLASH:n={id:e.identifier,url:e.http_file_path,bufferTime:e.buffer_time,onconnect:function(){t.log("Audio.load.lib.createSound.onConnect() - successfully connected over RTMP ("+e.flash_server_url+")",t.type.info),s.internal_events.trigger(s.events.type.MEDIA_READY,e)},onfailure:function(e){var n=s.current_playable;n.position>0?(t.log("Audio.load.createSound.onfailure() -- network connection has been lost",t.type.info),s.state.set(s.state.type.STOPPED,n),s.events.trigger(s.events.type.CONNECTION_LOST,n)):e.connected===!0?(t.log("Audio.load.createSound.onfailure() - requested file '"+n.flash_file_path+"' w/ identifier '"+n.identifier+"' could not be found in flash/RTMP mode.",t.type.error),s.state.set(s.state.type.STOPPED,n),s.events.trigger(s.events.type.MISSING_FILE,n),s.events.trigger(s.events.type.FINISHED,n)):(t.log("Audio.load.createSound.onfailure() - could not connect to '"+n.flash_server_url+"' ... falling back to HTML5-mode.",t.type.error),s.state.set(s.state.type.STOPPED,n),s.mechanism.removeCurrentSolution(),s.audio.reset())},onload:function(e){if(e===!1){var n=s.current_playable;s.events.trigger(s.events.type.MISSING_FILE,n),t.log("Audio.load.createSound.onload() - could not load '"+n.http_file_path+"' over progressive download",t.type.error)}}},e.flash_file_path!==null&&e.flash_file_path!==""&&e.flash_server_url!==null&&e.flash_server_url!==""&&(n.serverURL=e.flash_server_url,n.url=e.flash_file_path),this.lib.createSound(n);break;case s.mechanism.type.HTML5:n=this.lib.createSound({id:e.identifier,url:e.http_file_path,onload:function(e){var n=s.current_playable;e?this.duration?(n.duration=this.duration,t.log("Audio.load.createSound.onload(): duration found after start",t.type.info)):t.log("Audio.load.createSound.onload(): duration unknown",t.type.info):(s.state.set(s.state.type.STOPPED,n),s.events.trigger(s.events.type.MISSING_FILE,n),s.events.trigger(s.events.type.FINISHED,n),t.log("Audio.load.createSound.onload():  requested file '"+n.http_file_path+"' w/ identifier '"+n.identifier+"' could not be found in HTML5 mode.",t.type.error))}}),s.internal_events.trigger(s.events.type.MEDIA_READY,e);break;default:t.log("Audio.load() no playback solution exists.",t.type.error),s.events.trigger(s.events.type.PLAYER_FAILURE,e)}}catch(r){t.log("Exception thrown in APMPlayer.Audio.load : "+r.toString(),t.type.error)}else s.mechanism.getCurrentSolution()===null?s.events.trigger(s.events.type.PLAYER_FAILURE,e):t.log("Audio.lib.load - audio lib not initialized.  load() will be called again when player is finally initialized.",t.type.info)},unload:function(e){s.current_playable!==null&&(t.log("Audio.unload() about to stop, drop and roll current sound.",t.type.info),this.lib.destroySound(e.identifier),e.reset(),s.state.set(s.state.type.STOPPED,e),s.events.trigger(s.events.type.UNLOADED,e))},play:function(n){this.lib.getSoundById(n.identifier)?(t.log("Audio.play() attempting to play from lib.",t.type.info),this.lib.play(n.identifier,{volume:s.settings.volume*100,position:n.position,onplay:function(){s.state.set(s.state.type.PLAYING,n),s.events.trigger(s.events.type.PLAYING,n),s.events.trigger(s.events.type.METADATA,n),s.settings.muted&&this.mute(),t.log("Audio.play.onplay() PLAYING fired",t.type.info)},onpause:function(){s.state.set(s.state.type.PAUSED,n),s.events.trigger(s.events.type.PAUSED,n),t.log("Audio.play.onpause() PAUSED fired",t.type.info)},onresume:function(){s.state.set(s.state.type.PLAYING,n),s.events.trigger(s.events.type.PLAYING,n),t.log("Audio.play.onresume() PLAYING fired",t.type.info)},onfinish:function(){s.current_playable.reset(),s.state.set(s.state.type.STOPPED,n),s.events.trigger(s.events.type.FINISHED,n),t.log("Audio.play.onfinish() FINISHED fired; playable reset.",t.type.info)},onbufferchange:function(){this.isBuffering===!0?(s.events.trigger(s.events.type.BUFFER_START,n),t.log("Audio.play.onbufferchange() BUFFER_START fired ",t.type.info)):(s.events.trigger(s.events.type.BUFFER_END,n),t.log("Audio.play.onbufferchange() BUFFER_END fired ",t.type.info))},whileplaying:function(){var t=s.current_playable;t.type===e.type.LIVE_AUDIO?(t.percent_played=1,t.duration=0,t.position=this.position,s.events.trigger(s.events.type.POSITION_UPDATE,t)):(this.position!==0&&(t.position=this.position),this.duration!==0&&this.duration>t.duration&&(t.duration=this.duration),this.durationEstimate>this.duration?t.percent_loaded=this.duration/this.durationEstimate:t.percent_loaded>0&&t.percent_loaded<1&&(t.percent_loaded=1),t.duration>0&&(t.percent_played=t.position/t.duration),t.isEOF()?(t.percent_played=1,t.position=t.duration):s.events.trigger(s.events.type.POSITION_UPDATE,t))},onmetadata:function(){this.hasOwnProperty("metadata")&&(this.metadata.hasOwnProperty("adw_ad")&&this.metadata.adw_ad==="true"&&this.metadata.hasOwnProperty("metadata")&&this.metadata.metadata.indexOf("adswizzContext")!==-1?(t.log("onmetadata() received adw_ad of insertionType: '"+this.metadata.insertionType+"'",t.type.info),n.title="adw_ad_"+this.metadata.insertionType,n.adw_context=this.metadata.metadata.substr(15),s.events.trigger(s.events.type.METADATA,n)):this.metadata.hasOwnProperty("StreamTitle")&&typeof this.metadata.StreamTitle!="undefined"&&(t.log("onmetadata() received metadata w/ title: '"+this.metadata.StreamTitle+"'",t.type.info),n.title=this.metadata.StreamTitle,s.events.trigger(s.events.type.METADATA,n)))}})):this.load(n)},pause:function(e){var n=this.lib.getSoundById(e.identifier);return n?(n.pause(),!0):(t.log("Audio.pause() Error.  Could not pause.  '"+e.identifier+"' is unknown.",t.type.warn),!1)},unpause:function(e){var n=this.lib.getSoundById(e.identifier);return n&&n.paused===!0?(n.resume(),!0):(t.log("Audio.unpause() Error.  Could not unpause.  '"+e.identifier+"' is unknown.",t.type.warn),!1)},seek:function(e,n){var r=this.lib.getSoundById(e.identifier);if(r){if(e.duration){t.log("Audio.seek() seeking to '"+n+"' of sound '"+e.identifier+"'",t.type.info);var i=n*e.duration;return r.setPosition(i),!0}return t.log("Audio.seek() Error.  Could not seek. duration of '"+e.identifier+"' is unknown.",t.type.warn),!1}return t.log("Audio.seek() sound '"+e.identifier+"' is unknown.",t.type.warn),!1},mute:function(e){var t=this.lib.getSoundById(e.identifier);t&&t.mute()},unmute:function(e){var t=this.lib.getSoundById(e.identifier);t&&t.unmute()},setVolume:function(e,n){var r=n*100,i=this.lib.getSoundById(e.identifier);i?(t.log("Audio.setVolume() setting volume to "+r+"% (out of 100)",t.type.info),i.setVolume(r)):t.log("Audio.setVolume() sound is not loaded.  volume will be set to "+r+"% once audio begins playing",t.type.info)}},this.settings={volume:.9,muted:!1,debug:!1},this.current_playable=null,this.events=new n,this.internal_events=new n,this.mechanism=new i,this.state=new r,this.audio=new o,this.internal_event_handlers={checkReady:function(){s.audio.init_status===!0?(t.log("checkReady() player ready.  all dependencies loaded.",t.type.info),s.events.trigger(s.events.type.PLAYER_READY,{})):t.log("checkReady() not quite ready -- waiting for other dependencies to load...",t.type.info)},onMediaReady:function(e){s.audio.play(e)}},this.internal_events.addListener(s.events.type.AUDIO_LIB_READY,s.internal_event_handlers.checkReady),this.internal_events.addListener(s.events.type.MEDIA_READY,s.internal_event_handlers.onMediaReady),this.util={getParameterByName:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",n=new RegExp(t),r=n.exec(window.location.href);return r===null?"":decodeURIComponent(r[1].replace(/\+/g," "))},getLoadedScriptPathByFileName:function(e){var t=document.getElementsByTagName("script"),n=t.length,r;for(r=0;r<n;r+=1){var i=t[r].src.indexOf(e,0);if(i!==-1)return t[r].src.slice(0,i)}},getProjectBasePath:function(){var e=s.util.getLoadedScriptPathByFileName("script/apmplayer-all.min.js");return typeof e=="undefined"&&(e=s.util.getLoadedScriptPathByFileName("script/apmplayer.js")),e},mergeSettings:function(e){var t;for(t in e)e.hasOwnProperty(t)&&s.settings.hasOwnProperty(t)&&(s.settings[t]=e[t])},checkDebug:function(){s.util.getParameterByName("debug")&&(t.enabled=!0),s.util.getParameterByName("debug")==="all"&&(t.consoleOnly=!1)},addIEFixes:function(){Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n),n<0&&(n+=t);for(;n<t;n++)if(n in this&&this[n]===e)return n;return-1})}},{init:function(){s.util.addIEFixes(),s.util.checkDebug(),s.audio.init()},reset:function(e){e instanceof Array&&s.mechanism.setSolutions(e),s.audio.reset()},play:function(n,r){if(!(n instanceof u))return t.log("play() invalid playable passed.  must of of type Playable.  did nothing.",t.type.error),!1;if(n===s.current_playable&&s.state.current()!==s.state.type.PLAYING)switch(n.type){case e.type.AUDIO:case e.type.LIVE_AUDIO:s.audio.play(n);break;case e.type.VIDEO:break;default:t.log("play() unsupported type: '"+n.type+"'",t.type.error)}else if(n!==s.current_playable){if(s.mechanism.getCurrentSolution()===null)return t.log("play()  insufficient playback mechanism for platform.  Triggered PLAYER_FAILURE",t.type.error),s.events.trigger(s.events.type.PLAYER_FAILURE,n),!1;s.current_playable!==null&&s.audio.unload(s.current_playable),s.util.mergeSettings(r),s.current_playable=n;switch(n.type){case e.type.AUDIO:case e.type.LIVE_AUDIO:s.audio.load(n);break;case e.type.VIDEO:break;default:t.log("load() unsupported type: '"+n.type+"'",t.type.error)}}},pause:function(){var n=s.current_playable;if(n!==null)switch(n.type){case e.type.AUDIO:s.audio.pause(n);break;case e.type.LIVE_AUDIO:s.audio.unload(n);break;case e.type.VIDEO:break;default:t.log("pause() unsupported type: '"+n.type+"'",t.type.error)}else t.log("pause() no current playable loaded.  nothing to pause.",t.type.warn)},unload:function(){var n=s.current_playable;if(n!==null)switch(n.type){case e.type.AUDIO:case e.type.LIVE_AUDIO:s.audio.unload(n);break;case e.type.VIDEO:break;default:t.log("unload() unsupported type: '"+n.type+"'",t.type.error)}else t.log("unload() no current playable loaded.  nothing to stop/unload.",t.type.info)},seek:function(n){var r=s.current_playable;if(r!==null)switch(r.type){case e.type.AUDIO:s.audio.seek(r,n);break;case e.type.LIVE_AUDIO:t.log("seek() sorry, this item is not seekable '"+r.identifier+"', type: '"+r.type+"'",t.type.info);break;case e.type.VIDEO:break;default:t.log("seek() unsupported type: '"+r.type+"'",t.type.error)}else t.log("seek() no current playable loaded.  nothing to seek.",t.type.info)},mute:function(){s.settings.muted=!0;var n=s.current_playable;if(n!==null)switch(n.type){case e.type.AUDIO:case e.type.LIVE_AUDIO:s.audio.mute(n);break;case e.type.VIDEO:break;default:t.log("mute() unsupported type: '"+n.type+"'",t.type.error)}t.log("mute() -- player is now muted.",t.type.info)},unmute:function(){s.settings.muted=!1;var n=s.current_playable;if(n!==null)switch(n.type){case e.type.AUDIO:case e.type.LIVE_AUDIO:s.audio.unmute(n);break;case e.type.VIDEO:break;default:t.log("unmute() unsupported type: '"+n.type+"'",t.type.error)}t.log("unmute() -- player is now unmuted.",t.type.info)},setVolume:function(n){n<0?(n=0,t.log("setVolume() invalid percent_decimal passed: '"+n+"' is less than 0.  percent_decimal set to 0.  percentages must be represented as a decimal from 0 to 1 (eg .45)",t.type.warn)):n>1&&(n=1,t.log("setVolume() invalid percent_decimal passed: '"+n+"' is greater than 1.  percent_decimal set to 1.00 by default.  percentages must be represented as a decimal from 0.00 to 1.00 (eg .45)",t.type.warn));var r=s.current_playable;if(r!==null)switch(r.type){case e.type.AUDIO:case e.type.LIVE_AUDIO:s.audio.setVolume(r,n);break;case e.type.VIDEO:break;default:t.log("setVolume() unsupported type: '"+r.type+"'",t.type.error)}else t.log("setVolume() no playable loaded.  VOLUME_UPDATED event still fired. new vox : '"+n+"'",t.type.info);s.settings.volume=n,s.events.trigger(s.events.type.VOLUME_UPDATED,{percent_decimal:n})},debug:t,events:s.events,mechanism:s.mechanism,mediaTypes:e.type,state:s.state,base_path:s.util.getProjectBasePath()}},f=function(){this.events=new n,this._items=[],this._current_index=null};f.prototype={add:function(e){return e instanceof u&&e.isValid()?this.item(e.identifier)!==null?(t.log("add() could not add '"+e.identifier+"' to playlist because it already exists!",t.type.warn,"Playlist"),!1):(this._items.push(e),this._current_index===null&&(this._current_index=0,this.events.trigger(this.events.type.PLAYLIST_CURRENT_CHANGE,null)),t.log("add() new playable successfully added to playlist: '"+e.identifier+"'",t.type.info,"Playlist"),!0):(t.log("add() -- error: nothing added to playlist.  either object passed was not of type Playable or identifier '"+e.identifier+"' is invalid.",t.type.warn,"Playlist"),!1)},_count:function(){return this._items.length},current:function(){return this._current_index!==null?this._items[this._current_index]:null},item:function(e){var t,n=this._count();for(t=0;t<n;t+=1)if(this._items[t].identifier===e)return this._items[t];return null},"goto":function(e){var n,r=this._count();for(n=0;n<r;n+=1)if(this._items[n].identifier===e){var i=this.current();return this._current_index=n,this.events.trigger(this.events.type.PLAYLIST_CURRENT_CHANGE,i),!0}return t.log("goto() - invalid identifier passed '"+e+"'.  This was not found in the current playlist!",t.type.warn,"Playlist"),!1},hasNext:function(){return this._current_index+1<this._count()?!0:!1},remove:function(e){var n,r=this._count();for(n=0;n<r;n+=1)if(this._items[n].identifier===e)return this.current().identifier===e?(t.log("remove() -- sorry, you may not remove the current item in the playlist. returning false.)",t.type.warn,"Playlist"),!1):(this._items.splice(n,1),this._current_index>0&&n<=this._current_index&&(this._current_index-=1),!0);return!1},next:function(){if(this._current_index===null)return!1;t.log("next() advancing to next position in playlist (or to beginning if at last)",t.type.info,"Playlist");var e=this.current();this._current_index=this._current_index+1<this._count()?this._current_index+1:0,this.events.trigger(this.events.type.PLAYLIST_CURRENT_CHANGE,e)},previous:function(){if(this._current_index===null)return!1;t.log("previous() moving to previous position in playlist (or to last if at beginning)",t.type.info,"Playlist");var e=this.current();this._current_index=this._current_index-1>=0?this._current_index-1:this._count()-1,this.events.trigger(this.events.type.PLAYLIST_CURRENT_CHANGE,e)}};var l;return{getPlayer:function(){return typeof l=="undefined"&&(l=new a,l.constructor=null),l},getPlayable:function(e){return new u(e)},getPlaylist:function(){return new f},getCustomSchemes:function(){return o}}}();var scheme_map={apm_audio:{flash_server_url:"rtmp://archivemedia.publicradio.org/music",flash_file_prefix:"mp3:ondemand",http_file_prefix:"http://ondemand.publicradio.org",buffer_time:3,type:"audio"},apm_live_audio:{mpr_news:{flash_server_url:"rtmp://archivemedia.publicradio.org/news",flash_file_path:"news.stream",http_file_path:"http://newsstream1.publicradio.org:80/",buffer_time:6,type:"live_audio"},mpr_current:{flash_server_url:"rtmp://archivemedia.publicradio.org/kcmp",flash_file_path:"kcmp.stream",http_file_path:"http://currentstream1.publicradio.org:80/",buffer_time:6,type:"live_audio"},csf:{flash_server_url:"rtmp://archivemedia.publicradio.org/csf",flash_file_path:"csf.stream",http_file_path:"http://204.93.222.85:80/csf-nopreroll",buffer_time:6,type:"live_audio"},wpbi:{flash_server_url:"rtmp://archivemedia.publicradio.org/wpbistream",flash_file_path:"wpbi.stream",http_file_path:"http://wpbistream1.lbdns-streamguys.com:80/wpbistream",buffer_time:6,type:"live_audio"}}},custom_schemes=APMPlayerFactory.getCustomSchemes();custom_schemes.init(scheme_map);var APMPlayer=APMPlayerFactory.getPlayer();APMPlayer.init(),function(e){"use strict";var t=function(t,n){var r=this;this.parent_id="#"+t.attr("id"),this.args=n,this.init=function(){r.main.init(),r.controls.init(),r.events.init(),r.playlist.init()},this.main={settings:{autoplay:!1,muted:!1,fetchMetadata:!1,volume:.9},isReady:!1,init:function(){r.args.hasOwnProperty("settings")&&r.main.mergeSettings(r.args.settings),r.main.settings.autoplay===!0&&r.main.settings.fetchMetadata===!0&&(r.main.settings.autoplay="wait")},mergeSettings:function(e){var t;for(t in e)e.hasOwnProperty(t)&&r.main.settings.hasOwnProperty(t)&&(r.main.settings[t]=e[t])},canAutoPlay:function(){return r.main.settings.autoplay===!0&&APMPlayer.mechanism.getCurrentSolution()!==APMPlayer.mechanism.type.HTML5&&r.main.isReady===!0?!0:!1},updateAutoPlay:function(e){var t=r.playlist.current();t.identifier===e.identifier&&r.main.settings.autoplay==="wait"&&(r.main.settings.autoplay=!0)},fetchMetadata:function(e){r.events.onFetchMetadata(e)}},this.skin={css:{play:"apm_player_play",pause:"apm_player_pause",seeker:"apm_player_bar",seekerBufferingCls:"buffering",seekerLoading:"apm_player_loading",liveStreamingCls:"streaming",volumeWrapper:"apm_player_volume_wrapper",volumeMutedCls:"muted",volumeBar:"apm_volume_bar",volumeBarWrapper:"apm_player_volume_slider_wrapper",volumeStatus:"apm_player_volume_status",info:"apm_player_info",status:"apm_player_status",statusWarningCls:"warning",statusAlertCls:"alert",playtime:"apm_player_playtime",playlist:"apm_playlist",playlistNowPlayingCls:"nowplaying",sponsorOverlayActiveCls:"preroll-active",sponsorOverlayInactiveCls:"preroll-inactive",sponsorTimer:"apm_sponsor_overlay_time",sharingTools:"apm_sharing_tools",sharingTabControls:"apm_sharing_tab_controls",sharingTabCls:"apm_sharing_tab",sharingTabSharing:"apm_sharing_share",sharingTabDownload:"apm_sharing_download",sharingTabEmbed:"apm_sharing_embed",sharingTabLink:"apm_sharing_link"}},this.controls={init:function(){r.controls.seeker.init(),r.controls.info.init(),r.controls.volume.init(),r.controls.volumeStatus.init(),r.controls.pause.init(),r.controls.play.init(),r.controls.tools.init()},play:{init:function(){e(r.parent_id+" #"+r.skin.css.play).click(function(){APMPlayer.play(r.playlist.current(),r.main.settings)})}},pause:{init:function(){e(r.parent_id+" #"+r.skin.css.pause).click(function(){APMPlayer.pause()})}},seeker:{status:"NORMAL",init:function(){e(r.parent_id+" #"+r.skin.css.seeker).slider({disabled:!0,range:"min",start:function(e,t){r.controls.seeker.status="USER_SLIDING"},stop:function(e,t){r.events.onSeek(t.value/100),r.controls.seeker.status="NORMAL"},slide:function(e,t){r.controls.seeker.status="USER_SLIDING";var n=r.playlist.current();n.position=t.value/100*n.duration,r.controls.playtime.render(n)}})},update:function(t){if(r.controls.seeker.status==="NORMAL"){var n=100*t.percent_played;e(r.parent_id+" #"+r.skin.css.seeker).slider("value",n)}if(t.percent_loaded<=1){var i=100*t.percent_loaded;e(r.parent_id+" #"+r.skin.css.seekerLoading).width(i+"%")}},enable:function(){r.playlist.current().type!==APMPlayer.mediaTypes.LIVE_AUDIO&&e(r.parent_id+" #"+r.skin.css.seeker).slider("enable")},disable:function(){r.playlist.current().type===APMPlayer.mediaTypes.LIVE_AUDIO&&e(r.parent_id+" #"+r.skin.css.seeker).slider("disable")},reset:function(){e(r.parent_id+" #"+r.skin.css.seeker).slider("value",0)},configure:function(t){r.controls.seeker.reset(),t.type===APMPlayer.mediaTypes.LIVE_AUDIO?(r.controls.seeker.disable(),e(r.parent_id+" #"+r.skin.css.seeker).addClass(r.skin.css.liveStreamingCls)):(t.duration>0&&r.controls.seeker.enable(),e(r.parent_id+" #"+r.skin.css.seeker).removeClass(r.skin.css.liveStreamingCls))}},playtime:{convertToTime:function(e){var t=new Date(e),n=t.getUTCHours(),r=t.getUTCMinutes(),i=t.getUTCSeconds(),s=n,o=s>0&&r<10?"0"+r:r,u=i<10?"0"+i:i;return(s>0?s+":":"")+(o+":")+u},render:function(t){var n;t.duration>0?n=r.controls.playtime.convertToTime(t.position)+" / "+r.controls.playtime.convertToTime(t.duration):n=r.controls.playtime.convertToTime(t.position),e(r.parent_id+" #"+r.skin.css.playtime).text(n)}},volume:{init:function(){e(r.parent_id+" #"+r.skin.css.volumeBar).slider({range:"min",orientation:"vertical",value:r.main.settings.volume*100,stop:function(e,t){APMPlayer.setVolume(t.value/100),t.value>0&&r.main.settings.muted&&(APMPlayer.unmute(),r.controls.volumeStatus.renderUnmuted(),r.main.settings.muted=!1)}}),e(r.parent_id+" #"+r.skin.css.volumeWrapper).hover(function(){e(r.parent_id+" #"+r.skin.css.volumeBarWrapper).show()},function(){e(r.parent_id+" #"+r.skin.css.volumeBarWrapper).fadeOut(500)})},renderMuted:function(){e(r.parent_id+" #"+r.skin.css.volumeBar).slider("value",0)},renderUnmuted:function(){e(r.parent_id+" #"+r.skin.css.volumeBar).slider("value",r.main.settings.volume*100)}},volumeStatus:{init:function(){e(r.parent_id+" #"+r.skin.css.volumeStatus).click(function(){r.main.settings.muted?(APMPlayer.unmute(),r.main.settings.muted=!1,r.controls.volume.renderUnmuted(),r.controls.volumeStatus.renderUnmuted()):(APMPlayer.mute(),r.main.settings.muted=!0,r.controls.volume.renderMuted(),r.controls.volumeStatus.renderMuted())})},renderMuted:function(){e(r.parent_id+" #"+r.skin.css.volumeStatus).addClass(r.skin.css.volumeMutedCls)},renderUnmuted:function(){e(r.parent_id+" #"+r.skin.css.volumeStatus).removeClass(r.skin.css.volumeMutedCls)}},info:{init:function(){r.args.hasOwnProperty("onMetadata")&&(r.events.onMetadata=r.args.onMetadata)}},status:{displayWarning:function(t){e(r.parent_id+" #"+r.skin.css.status).html(t),e(r.parent_id+" #"+r.skin.css.status).addClass(r.skin.css.statusWarningCls)},displayAlert:function(t){e(r.parent_id+" #"+r.skin.css.status).html(t),e(r.parent_id+" #"+r.skin.css.status).addClass(r.skin.css.statusAlertCls)},clearAll:function(){e(r.parent_id+" #"+r.skin.css.status).removeClass(r.skin.css.statusAlertCls),e(r.parent_id+" #"+r.skin.css.status).removeClass(r.skin.css.statusWarningCls),e(r.parent_id+" #"+r.skin.css.status).html("")}},tools:{init:function(){r.args.hasOwnProperty("tools")&&r.args.tools.hasOwnProperty("config")&&(r.controls.tools.config=r.args.tools.config),r.controls.tools.config()},config:function(){e(r.parent_id+" #"+r.skin.css.sharingTools+" ."+r.skin.css.sharingTabCls).hide(),e(r.parent_id+" #"+r.skin.css.sharingTools+" ."+r.skin.css.sharingTabCls+":first").show(),e(r.parent_id+" #"+r.skin.css.sharingTools+" ul#"+r.skin.css.sharingTabControls+" li:first").addClass("active"),e(r.parent_id+" #"+r.skin.css.sharingTools+" ul#"+r.skin.css.sharingTabControls+" li a").click(function(){e(r.parent_id+" #"+r.skin.css.sharingTools+" ul#"+r.skin.css.sharingTabControls+" li").removeClass("active"),e(this).parent().addClass("active");var t=e(this).attr("href");return e(r.parent_id+" #"+r.skin.css.sharingTools+" ."+r.skin.css.sharingTabCls).hide(),e(t).show(),!1})},renderDownload:function(t){var n="";t.downloadable===!0&&r.playlist.current().type===APMPlayer.mediaTypes.AUDIO?n='<a href="'+APMPlayer.base_path+"util/download.php?uri="+t.http_file_path+'">file download</a>':n="sorry, this item is not downloadable.",e(r.parent_id+" #"+r.skin.css.sharingTools+" #"+r.skin.css.sharingTabDownload).html(n)}}},this.events={init:function(){APMPlayer.events.addListener(APMPlayer.events.type.PLAYER_READY,r.events.onPlayerReady),APMPlayer.events.addListener(APMPlayer.events.type.PLAYING,r.events.onPlaying),APMPlayer.events.addListener(APMPlayer.events.type.PAUSED,r.events.onPaused),APMPlayer.events.addListener(APMPlayer.events.type.METADATA,r.events.onMetadata),APMPlayer.events.addListener(APMPlayer.events.type.BUFFER_START,r.events.onBufferStart),APMPlayer.events.addListener(APMPlayer.events.type.BUFFER_END,r.events.onBufferEnd),APMPlayer.events.addListener(APMPlayer.events.type.POSITION_UPDATE,r.events.onPositionUpdate),APMPlayer.events.addListener(APMPlayer.events.type.FINISHED,r.events.onFinished),APMPlayer.events.addListener(APMPlayer.events.type.UNLOADED,r.events.onUnloaded),APMPlayer.events.addListener(APMPlayer.events.type.VOLUME_UPDATED,r.events.onVolumeUpdated),APMPlayer.events.addListener(APMPlayer.events.type.CONNECTION_LOST,r.events.onConnectionLost),APMPlayer.events.addListener(APMPlayer.events.type.PLAYER_FAILURE,r.events.onFailure
),APMPlayer.events.addListener(APMPlayer.events.type.MISSING_FILE,r.events.onMissingFile)},onPlayerReady:function(){r.main.isReady=!0;if(r.main.canAutoPlay())APMPlayer.play(r.playlist.current(),r.main.settings);else{var e=r.playlist.current();e!==null&&r.events.onMetadata(e)}},onPlaying:function(t){r.controls.seeker.enable(),r.controls.status.clearAll(),e(r.parent_id+" #"+r.skin.css.play).hide(),e(r.parent_id+" #"+r.skin.css.pause).show(),r.playlist.addNowPlaying(t)},onPaused:function(t){e(r.parent_id+" #"+r.skin.css.play).show(),e(r.parent_id+" #"+r.skin.css.pause).hide(),t.type===APMPlayer.mediaTypes.LIVE_AUDIO&&r.controls.seeker.reset()},onFinished:function(){r.controls.seeker.disable(),r.playlist.hasNext()?r.playlist.next():APMPlayer.unload()},onPositionUpdate:function(e){r.controls.seeker.update(e),r.controls.seeker.status!=="USER_SLIDING"&&r.controls.playtime.render(e)},onSeek:function(e){if(APMPlayer.state.current()!==APMPlayer.state.type.STOPPED)APMPlayer.seek(e);else{var t=r.playlist.current();t.duration>0&&(t.percent_played=e,t.position=t.duration*e,r.controls.playtime.render(t))}},onUnloaded:function(t){r.controls.seeker.reset(),r.controls.playtime.render(t),e(r.parent_id+" #"+r.skin.css.play).show(),e(r.parent_id+" #"+r.skin.css.pause).hide()},onBufferStart:function(){APMPlayer.state.current()===APMPlayer.state.type.PLAYING&&e(r.parent_id+" #"+r.skin.css.seeker).addClass(r.skin.css.seekerBufferingCls)},onBufferEnd:function(){e(r.parent_id+" #"+r.skin.css.seeker).removeClass(r.skin.css.seekerBufferingCls)},onFetchMetadata:function(e){APMPlayer.debug.log("events.onFetchMetadata() pass-through hit for  '"+e.identifier+"'",APMPlayer.debug.type.info,"APMPlayerUI");var t=r.playlist.current();e.identifier===t.identifier&&(r.events.onMetadata(t),r.controls.tools.renderDownload(t),t.duration>0&&(r.controls.playtime.render(t),t.isFlashStreamable()&&(r.controls.seeker.enable(),t.position>0&&(t.percent_played=t.position/t.duration),r.controls.seeker.update(t))),r.main.updateAutoPlay(t),r.main.canAutoPlay()&&APMPlayer.play(r.playlist.current(),r.main.settings))},onMetadata:function(){},onFailure:function(){var e=r.playlist.current(),t='<p>We\'re sorry, but your browser is not able to play the stream.  Please try one of these options:  <br /><br />1) Install or enable <a href="http://get.adobe.com/flashplayer/" target="_blank">Adobe Flash Player</a> <br />2) Use a browser that supports HTML5 and MP3 audio, such as <a href="http://www.google.com/chrome/" target="_blank">Chrome</a>, <a href="http://www.apple.com/safari/download/" target="_blank">Safari</a>, or <a href="http://www.microsoft.com/ie9" target="_blank">Internet Explorer 9</a>';/Safari/.test(navigator.userAgent)&&/Apple Computer/.test(navigator.vendor)&&(t='<p>We\'re sorry, but your browser is not able to play the stream.  Please try one of these options:  <br /><br />1) Install or enable <a href="http://get.adobe.com/flashplayer/" target="_blank">Adobe Flash Player</a> <br />2) Install <a href="http://www.apple.com/quicktime/download/" target="_blank">Quicktime</a> for HTML5 support for Safari on Windows (requires reboot) <br />2b) Use a different browser that natively supports HTML5 and MP3 audio, such as <a href="http://www.google.com/chrome/" target="_blank">Chrome</a> or <a href="http://www.microsoft.com/ie9" target="_blank">Internet Explorer 9</a>'),e.downloadable===!0&&e.http_file_path!==""&&(e.type===APMPlayer.mediaTypes.AUDIO?t+='<br />3) <a href="'+APMPlayer.base_path+"util/download.php?uri="+e.http_file_path+'">download the audio</a>':e.type===APMPlayer.mediaTypes.LIVE_AUDIO&&(t+='<br />3) <a href="'+e.http_file_path+'">Stream the audio using a third-party player (eg. iTunes)</a>')),t+="</p>",r.controls.status.displayWarning(t)},onVolumeUpdated:function(e){r.main.settings.volume=e.percent_decimal},onConnectionLost:function(){APMPlayer.unload();var e="<p>Your network connection has changed or has been lost.<br /><br />Please check your connection, then click play to resume.";r.controls.status.displayAlert(e)},onMissingFile:function(e){var t="<p>We're sorry, an error has occurred and your audio cannot be played at this time. <br /><br />Often, this error is a result of a poor or missing internet connection.  Please check your internet connection, then click play to resume.";r.controls.status.displayWarning(t),r.underwriting.removeOverlay()}},this.playlist=APMPlayerFactory.getPlaylist(),r.playlist.onUpdate=function(e){},r.playlist.init=function(){r.args.hasOwnProperty("onPlaylistUpdate")&&(r.playlist.onUpdate=r.args.onPlaylistUpdate),r.args.hasOwnProperty("playables")&&e.each(r.args.playables,function(e,t){r.playlist.addPlayable(t)})},r.playlist.addPlayable=function(e){var t=APMPlayerFactory.getPlayable(e);t.isValid()?(r.playlist.add(t),r.playlist.onUpdate(t),r.main.settings.fetchMetadata===!0&&(t.isCustomScheme("apm_audio")?r.main.fetchMetadata(t):r.main.updateAutoPlay(t))):APMPlayer.debug.log("sorry, there was a problem with the parameters passed and a valid playable could not be created.",APMPlayer.debug.type.warn,"APMPlayerUI")},r.playlist.gotoItem=function(e){if(APMPlayer.state.current()===APMPlayer.state.type.STOPPED||r.playlist.current().identifier!==e)r.controls.seeker.disable(),r.playlist.goto(e)},r.playlist.addNowPlaying=function(t){e("li[ id = '"+t.identifier+"']").addClass(r.skin.css.playlistNowPlayingCls)},r.playlist.removeNowPlaying=function(t){e(r.parent_id+" #"+r.skin.css.playlist+" li[ id = '"+t.identifier+"']").removeClass(r.skin.css.playlistNowPlayingCls)},r.playlist.onCurrentChange=function(e){e!==null&&(r.playlist.removeNowPlaying(e),APMPlayer.play(r.playlist.current(),r.main.settings));var t=r.playlist.current();r.controls.seeker.configure(t),r.controls.tools.renderDownload(t),t.duration>0&&r.controls.playtime.render(t)},r.playlist.events.addListener(APMPlayer.events.type.PLAYLIST_CURRENT_CHANGE,r.playlist.onCurrentChange),r.init()};e.fn.apmplayer_ui=function(n){if(typeof APMPlayer=="undefined"||typeof soundManager=="undefined")return e.error("apmplayer_ui ERROR.  1 or more dependent libraries missing.  exiting."),null;var r=this,i={addPlayable:function(e){typeof window.apmplayer_ui!="undefined"?window.apmplayer_ui.playlist.addPlayable(e):APMPlayer.debug.log("you must first initialize apmplayer_ui before calling methods on it.",APMPlayer.debug.type.error,"APMPlayerUI")},gotoPlaylistItem:function(e){typeof window.apmplayer_ui!="undefined"?window.apmplayer_ui.playlist.gotoItem(e):APMPlayer.debug.log("you must first initialize apmplayer_ui before calling methods on it.",APMPlayer.debug.type.error,"APMPlayerUI")}};if(i[n])return i[n].apply(this,Array.prototype.slice.call(arguments,1));typeof n=="object"||!n?typeof window.apmplayer_ui=="undefined"?(window.apmplayer_ui=new t(r,n),APMPlayer.debug.log("instantiated apmplayer_ui",APMPlayer.debug.type.info,"APMPlayerUI")):APMPlayer.debug.log("sorry, only one player UI instance is currently supported.",APMPlayer.debug.type.error,"APMPlayerUI"):APMPlayer.debug.log("Method "+n+" does not exist on jQuery.apmplayer_ui",APMPlayer.debug.type.error,"APMPlayerUI")}}(jQuery);